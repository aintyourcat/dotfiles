#!/bin/bash

# Mode and it's relevant icon to show
mode=('Start' 'Notify' 'Resume' 'Pause' 'Stop')
icon=('󰐊' '󰂚' '󰐊' '󰏤' '󰓛')
# Rofi command to use
prompt='rofi -dmenu -p Pomodoro -sep | -no-show-icons'
# Directory to store pomodoro status
cache_folder=$HOME/.cache/rofi-pomo/

# If pomodoro is started ...
if pgrep spt &> /dev/null; then
    # Check the status and display relevant mode
    if [[ -f $cache_folder/status ]]; then
        for ((i=1; i<${#mode[*]}; i++)); do
            if grep -q 'playing' $cache_folder/status; then
                [ $i -eq 2 ] && continue
            elif grep -q 'paused' $cache_folder/status; then
                [ $i -eq 3 ] && continue
            fi
            option="${option}|${icon[i]} ${mode[i]}"
            option=${option#|}
        done
    fi
    prompt="$prompt -lines 3"
# If pomodoro is not started yet...
else
    # Display start mode only
    option="${icon[0]} ${mode[0]}"
    prompt="$prompt -lines 1"
fi

# Choose a mode
chosen=$(echo $option | $prompt)
chosen=${chosen#? }

case $chosen in
    Start)
        # Create a cache directory if it isn't exist
        [ ! -d $cache_folder ] && mkdir $cache_folder
        # Start pomodoro
        spt -e "" -n "" &> /dev/null &
        # Set the status
        echo 'playing' > $cache_folder/status
        ;;
    Notify) pkill -USR1 spt ;;
    Pause)
        # Pause and update the status
        pkill -USR2 spt && pkill -USR1 spt
        echo 'paused' > $cache_folder/status
        ;;
    Resume)
        # Resume and update the status
        pkill -USR2 spt && pkill -USR1 spt
        echo 'playing' > $cache_folder/status
        ;;
    Stop)
        # Confirm to stop
        prompt="rofi -dmenu -p $chosen? -sep | -no-show-icons -lines 2"
        answer=$(echo '󰅖 No|󰄬 Yes' | $prompt)
        # Stop pomodoro and clear the cache folder
        [ ${answer#? } = "Yes" ] && killall -q spt && notify-send 'spt' 'bye-bye' && rm $cache_folder/*
        ;;
esac
