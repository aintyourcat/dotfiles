#!/usr/bin/env bash

# Normal and hidden window ids on current workspace
normal_window_ids=$(bspc query --nodes --desktop focused --node .\!hidden.window)
hidden_window_ids=$(bspc query --nodes --desktop focused --node .hidden.window)

# If any window is opened or hidden
if [ -n "$normal_window_ids" ] || [ -n "$hidden_window_ids" ]; then
    # If wmctrl command exists
    if type wmctrl > /dev/null 2>&1; then
        # All window ids and titles
        all_window_infos=$(wmctrl -l | tr -s ' ' | cut -d ' ' -f 1,4-) 

        # Normal window ids and titles on current workspace
        if [ -n "$normal_window_ids" ]; then
            : $(tr '\n' '|' <<< "$normal_window_ids")
            : ${_%|}
            normal_window_infos=$(grep -Ei $_ <<< "$all_window_infos")
        fi

        # Hidden window ids and titles on current workspace
        if [ -n "$hidden_window_ids" ]; then
            : $(tr '\n' '|' <<< "$hidden_window_ids")
            : ${_%|}
            hidden_window_infos=$(grep -Ei $_ <<< "$all_window_infos" | sed -E 's/ (.*)/ [Hidden] \1/1')
        fi

        # Normal and/or hidden window ids and titles on current workspace
        if [ -n "$hidden_window_infos" ]; then
            all_window_infos=$(printf "%s\n" "$hidden_window_infos" "$normal_window_infos")
        else
            all_window_infos="$normal_window_infos"
        fi

        # Get active window index
        active_win_id=$(bspc query --nodes --node focused.window)
        if [ -n "$active_win_id" ]; then
            active_win_index=$(grep -in "$active_win_id" <<< "$all_window_infos" | cut -d ':' -f 1)
            active_win_index=$(( $active_win_index - 1 )) # rofi row indices start at 0
        else
            active_win_index=''
        fi

        # Select a window
        window_to_show=$(cut -d ' ' -f 2- <<< "$all_window_infos" | \
            rofi -dmenu -p 'Change window' -format d:s -no-show-icons \
                -p 'Change window' -format d:s -no-show-icons \
                -width 40 -l 8 -theme-str 'window {width: 50%;}' -a "$active_win_index" -i -kb-accept-entry 'Super_L,Return')

        # Unhide and focus on selected window
        if [ -n "$window_to_show" ]; then
            selected_window_index=${window_to_show:0:1}
            selected_window_id=$(sed -n "$selected_window_index p" <<< "$all_window_infos" | cut -d ' ' -f 1)
            bspc node "$selected_window_id" --flag hidden=off --focus
        fi
    fi
fi
