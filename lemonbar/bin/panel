#!/bin/sh

. $XDG_CONFIG_HOME/lemonbar/config
. $(command -v colors)

test ! -p $PANEL_FIFO && mkfifo $PANEL_FIFO -m 600

trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

for module in $XDG_CONFIG_HOME/lemonbar/modules/*; do
    "$module" > $PANEL_FIFO &
done

while IFS= read -r event; do
    eval "${event%% *}='${event#* }'"
    eval "printf '%s\n' \"$PANEL_FORMAT\"" | tee ~/.cache/panel.modules
done < $PANEL_FIFO |
    lemonbar -p \
    -B $BACKGROUND \
    -F $FOREGROUND \
    -g x$PANEL_HEIGHT \
    -f $FONT_MEDIUM \
    -f $FONT_BOLD \
    -n $PANEL_WM_NAME &

xdo lower -ma "$PANEL_WM_NAME"

wait
